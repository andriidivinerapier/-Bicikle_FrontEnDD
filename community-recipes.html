<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ—Ü–µ–ø—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ ‚Äî CookBook</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/recipes.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/auth-modal.css">
    <link rel="stylesheet" href="css/auth-toast.css">
</head>
<body>
    <div class="fade-page visible">
        <!-- Header Navigation -->
        <header class="header">
            <nav class="nav-container">
                <div class="logo">
                    <h1>–°–º–∞—á–Ω–æ <span aria-hidden="true">:)</span></h1>
                </div>
                <ul class="nav-links">
                    <li><a href="index.html">–ì–æ–ª–æ–≤–Ω–∞</a></li>
                    <li><a href="recipes.html">–†–µ—Ü–µ–ø—Ç–∏</a></li>
                    <li><a href="community-recipes.html" class="active">–†–µ—Ü–µ–ø—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</a></li>
                    <li><a href="about.html">–ü—Ä–æ –Ω–∞—Å</a></li>
                    <li><a href="contacts.html">–ö–æ–Ω—Ç–∞–∫—Ç–∏</a></li>
                </ul>
                <div class="nav-actions">
                    <div class="search-container">
                        <input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫ —Ä–µ—Ü–µ–ø—Ç—ñ–≤...">
                        <button class="search-btn">üîç</button>
                    </div>
                    <button class="login-btn" id="loginBtn">–£–≤—ñ–π—Ç–∏</button>

                    <!-- Profile dropdown shown when user is logged in -->
                    <div class="profile-container" id="profileContainer" style="display: none;">
                        <button class="profile-btn" id="profileBtn" aria-haspopup="true" aria-expanded="false">
                            <span class="profile-avatar">üë§</span>
                            <span class="profile-name" id="profileName">–ü—Ä–æ—Ñ—ñ–ª—å</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="profile-menu" id="profileMenu" role="menu" aria-hidden="true">
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="recipes-page" style="padding:2rem; margin-top:70px;">
            <div class="recipes-header">
                <div>
                    <h2>üë• –†–µ—Ü–µ–ø—Ç–∏ –≤—ñ–¥ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏</h2>
                    <p style="color: #9aa6b6; margin-top: 0.5rem;">–í—ñ–¥–∫—Ä–∏–≤–∞–π—Ç–µ –Ω–æ–≤—ñ —Å–º–∞—á–Ω—ñ —Ä–µ—Ü–µ–ø—Ç–∏, —Å—Ç–≤–æ—Ä–µ–Ω—ñ —ñ–Ω—à–∏–º–∏ –∫—É–ª—ñ–Ω–∞—Ä–∞–º–∏</p>
                </div>
                <div class="header-actions">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <input type="text" id="filterInput" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é, –∫–∞—Ç–µ–≥–æ—Ä—ñ—î—é –∞–±–æ –∞–≤—Ç–æ—Ä–æ–º..." style="padding: 0.75rem 1rem; border: 1px solid #9aa6b6; border-radius: 8px; background: var(--bg-2); color: var(--text-primary); min-width: 300px;">
                        <button class="catalog-button" id="filterBtn">üîç –ü–æ—à—É–∫</button>
                    </div>
                </div>
            </div>

            <!-- Recipes Grid -->
            <section class="recipes-grid" id="recipesGrid" aria-live="polite">
                <!-- recipes will be injected here -->
            </section>

            <!-- No Recipes Message -->
            <div id="noRecipesMessage" style="max-width:1200px;margin:2rem auto;display:none;text-align:center;color:#9aa6b6;">
                <p style="font-size:1.2rem;">üòî –†–µ—Ü–µ–ø—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</p>
                <p>–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—ó –ø–æ—à—É–∫—É –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å —Å–≤—ñ–π —Ä–µ—Ü–µ–ø—Ç!</p>
            </div>

            <!-- Loading indicator -->
            <div id="loadingSpinner" style="max-width:1200px;margin:2rem auto;text-align:center;display:none;">
                <p style="color: #9aa6b6;">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ—Ü–µ–ø—Ç—ñ–≤...</p>
            </div>
        </main>

        <!-- Recipe Modal -->
        <div id="recipeModal" class="modal" style="display:none;" aria-hidden="true">
            <div class="modal-content">
                <button id="modalClose" class="modal-close">‚úï</button>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <img id="modalImage" src="" alt="" style="width: 100%; border-radius: 8px; object-fit: cover; max-height: 400px;">
                    <div>
                        <h2 id="modalTitle"></h2>
                        <p style="color: #9aa6b6; margin-bottom: 1rem;">
                            <span id="modalAuthor"></span> ‚Ä¢ <span id="modalDate"></span>
                        </p>
                        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                            <span class="tag difficulty" id="modalCategory" style="padding: 0.5rem 1rem; border-radius: 20px; background: var(--bg-secondary);">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</span>
                        </div>
                        <h3>ü•ò –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏:</h3>
                        <ul id="modalIngredients" style="margin: 1rem 0; list-style-position: inside;">
                        </ul>
                        <h3 style="margin-top: 1.5rem;">üìñ –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó:</h3>
                        <ol id="modalInstructions" style="margin: 1rem 0; list-style-position: inside;">
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auth Modal -->
        <div id="authModal" class="auth-modal" aria-hidden="true" style="display: none;">
            <div class="auth-modal__wrapper">
                <button id="authModalClose" class="auth-modal__close">‚úï</button>
                <div class="auth-modal__content">
                    <div class="auth-tabs">
                        <button class="auth-tab active" data-tab="login">–í—Ö—ñ–¥</button>
                        <button class="auth-tab" data-tab="register">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
                    </div>

                    <!-- Login Form -->
                    <form id="loginForm" class="auth-form active">
                        <div class="form-group">
                            <label for="loginEmail">Email</label>
                            <input type="email" id="loginEmail" name="loginEmail" placeholder="–í–≤–µ–¥—ñ—Ç—å email" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" id="loginPassword" name="loginPassword" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" required>
                        </div>
                        <button type="submit" class="btn btn-primary">–£–≤—ñ–π—Ç–∏</button>
                    </form>

                    <!-- Register Form -->
                    <form id="registerForm" class="auth-form">
                        <div class="form-group">
                            <label for="registerName">–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
                            <input type="text" id="registerName" name="registerName" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è" required>
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">Email</label>
                            <input type="email" id="registerEmail" name="registerEmail" placeholder="–í–≤–µ–¥—ñ—Ç—å email" required>
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" id="registerPassword" name="registerPassword" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" required>
                        </div>
                        <button type="submit" class="btn btn-primary">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/transition.js"></script>
    <script src="js/auth-modal.js"></script>
    <script>
    // Community Recipes Page
    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.getElementById('recipesGrid');
        const noRecipesMsg = document.getElementById('noRecipesMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const filterInput = document.getElementById('filterInput');
        const filterBtn = document.getElementById('filterBtn');
        const modal = document.getElementById('recipeModal');
        const modalClose = document.getElementById('modalClose');

        // Escape HTML
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Render a single recipe card
        function renderRecipe(recipe) {
            const article = document.createElement('article');
            article.className = 'recipe-card';

            const image = (recipe.image_path && recipe.image_path.trim()) ? recipe.image_path : 'images/homepage/salad1.jpg';
            const ingredients = recipe.ingredients || '';
            const firstIngredient = ingredients.split('|')[0] || '–†–µ—Ü–µ–ø—Ç';
            const created = recipe.created_at ? recipe.created_at.split(' ')[0] : '–ù–µ–¥–∞–≤–Ω–æ';

            article.innerHTML = `
                <div class="recipe-image" style="background-image: url('${escapeHtml(image)}')"></div>
                <div class="recipe-info">
                    <h4>${escapeHtml(recipe.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏')}</h4>
                    <p class="recipe-description" style="font-size: 0.9rem; color: #9aa6b6;">üë®‚Äçüç≥ ${escapeHtml(recipe.username || '–ê–≤—Ç–æ—Ä')}</p>
                    <p class="recipe-description">${escapeHtml(firstIngredient)}</p>
                    <div class="recipe-meta">
                        <div class="meta-left">
                            <span class="cook-time">${escapeHtml(created)}</span>
                            <span class="recipe-category">${escapeHtml(recipe.category || '–ó–∞–≥–∞–ª—å–Ω–µ')}</span>
                        </div>
                        <div class="meta-right">
                            <button class="details-btn recipe-view-btn" data-recipe='${JSON.stringify(recipe).replace(/'/g, "&apos;")}'>–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
                            <button class="recipe-like" aria-label="–î–æ–¥–∞—Ç–∏ –≤ —É–ª—é–±–ª–µ–Ω—ñ">‚ù§Ô∏è</button>
                        </div>
                    </div>
                </div>
            `;

            grid.appendChild(article);
        }

        // Load all recipes
        function loadRecipes(searchTerm = '') {
            console.log('üì• –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ä–µ—Ü–µ–ø—Ç–∏ –≤—ñ–¥ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏...');
            
            loadingSpinner.style.display = 'block';
            grid.innerHTML = '';
            noRecipesMsg.style.display = 'none';
            
            const url = searchTerm 
                ? `backend/get-all-recipes.php?search=${encodeURIComponent(searchTerm)}`
                : 'backend/get-all-recipes.php';
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞:', data);
                    loadingSpinner.style.display = 'none';
                    
                    if (data.status === 'success' && Array.isArray(data.recipes) && data.recipes.length > 0) {
                        data.recipes.forEach(recipe => renderRecipe(recipe));
                        noRecipesMsg.style.display = 'none';
                        console.log(`‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${data.recipes.length} —Ä–µ—Ü–µ–ø—Ç—ñ–≤`);
                    } else {
                        noRecipesMsg.style.display = 'block';
                        console.log('‚ÑπÔ∏è –†–µ—Ü–µ–ø—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                    }
                })
                .catch(error => {
                    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', error);
                    loadingSpinner.style.display = 'none';
                    grid.innerHTML = `<p style="color:#ff6b6b; grid-column: 1/-1; text-align: center;">‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ—Ü–µ–ø—Ç—ñ–≤</p>`;
                });
        }

        // Open recipe modal
        function openRecipeModal(recipe) {
            document.getElementById('modalImage').src = (recipe.image_path && recipe.image_path.trim()) ? recipe.image_path : 'images/homepage/salad1.jpg';
            document.getElementById('modalTitle').textContent = recipe.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏';
            document.getElementById('modalAuthor').textContent = `üë®‚Äçüç≥ ${recipe.username || '–ê–≤—Ç–æ—Ä'}`;
            document.getElementById('modalDate').textContent = recipe.created_at ? recipe.created_at.split(' ')[0] : '–ù–µ–¥–∞–≤–Ω–æ';
            document.getElementById('modalCategory').textContent = recipe.category || '–ó–∞–≥–∞–ª—å–Ω–µ';
            
            const ingredientsList = document.getElementById('modalIngredients');
            ingredientsList.innerHTML = '';
            (recipe.ingredients || '').split('|').forEach(ing => {
                if (ing.trim()) {
                    const li = document.createElement('li');
                    li.textContent = ing.trim();
                    ingredientsList.appendChild(li);
                }
            });
            
            const instructionsList = document.getElementById('modalInstructions');
            instructionsList.innerHTML = '';
            (recipe.instructions || '').split('|').forEach(step => {
                if (step.trim()) {
                    const li = document.createElement('li');
                    li.textContent = step.trim();
                    instructionsList.appendChild(li);
                }
            });
            
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
        }

        // Close modal
        function closeModal() {
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
        }

        // Event listeners
        filterBtn.addEventListener('click', () => {
            const searchTerm = filterInput.value.trim();
            loadRecipes(searchTerm);
        });

        filterInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = filterInput.value.trim();
                loadRecipes(searchTerm);
            }
        });

        modalClose.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // Delegate click for recipe view buttons
        grid.addEventListener('click', (e) => {
            if (e.target.classList.contains('recipe-view-btn')) {
                try {
                    const recipeData = JSON.parse(e.target.dataset.recipe);
                    openRecipeModal(recipeData);
                } catch (err) {
                    console.error('Error parsing recipe:', err);
                }
            }
        });

        // Initial load
        loadRecipes();
    });
    </script>
</body>
</html>
