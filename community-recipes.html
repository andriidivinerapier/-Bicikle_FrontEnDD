<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ—Ü–µ–ø—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ ‚Äî CookBook</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="css/style.css?v=2">
    <link rel="stylesheet" href="css/recipes.css?v=2">
    <link rel="stylesheet" href="css/recipe-cards.css?v=2">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/auth-modal.css">
    <link rel="stylesheet" href="css/auth-toast.css">
    <link rel="stylesheet" href="css/comments.css">
</head>
<body>
    <div class="fade-page visible">
        <!-- Header Navigation -->
        <header class="header">
            <nav class="nav-container">
                <div class="logo">
                    <h1>–°–º–∞—á–Ω–æ <span aria-hidden="true">:)</span></h1>
                </div>
                <ul class="nav-links">
                    <li><a href="index.html">–ì–æ–ª–æ–≤–Ω–∞</a></li>
                    <li><a href="recipes.html">–†–µ—Ü–µ–ø—Ç–∏</a></li>
                    <li><a href="community-recipes.html" class="active">–†–µ—Ü–µ–ø—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</a></li>
                    <li><a href="about.html">–ü—Ä–æ –Ω–∞—Å</a></li>
                    <li><a href="contacts.html">–ö–æ–Ω—Ç–∞–∫—Ç–∏</a></li>
                </ul>
                <div class="nav-actions">
                    <button class="login-btn" id="loginBtn">–£–≤—ñ–π—Ç–∏</button>

                    <!-- Profile dropdown shown when user is logged in -->
                    <div class="profile-container" id="profileContainer" style="display: none;">
                        <button class="profile-btn" id="profileBtn" aria-haspopup="true" aria-expanded="false">
                            <span class="profile-avatar">üë§</span>
                            <span class="profile-name" id="profileName">–ü—Ä–æ—Ñ—ñ–ª—å</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="profile-menu" id="profileMenu" role="menu" aria-hidden="true">
                            <a href="profile.html" class="profile-menu-item">–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</a>
                            <a href="profile.html?tab=recipes" class="profile-menu-item">–ú–æ—ó —Ä–µ—Ü–µ–ø—Ç–∏</a>
                            <a href="profile.html?tab=favorites" class="profile-menu-item">–£–ª—é–±–ª–µ–Ω—ñ</a>
                            <div id="adminMenuSeparator" style="display: none; border-top: 1px solid #ddd; margin: 8px 0;"></div>
                            <a href="admin.html" class="profile-menu-item" id="adminMenuLink" style="display: none; color: #e74c3c; font-weight: 600;">üìä –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</a>
                            <button id="logoutBtn" class="profile-menu-item" style="width: 100%; text-align: left; background: none; border: none; color: inherit; cursor: pointer;">–í–∏–π—Ç–∏</button>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="recipes-page" style="padding:2rem; margin-top:70px;">
            <div class="recipes-header">
                <div>
                    <h2>üë• –†–µ—Ü–µ–ø—Ç–∏ –≤—ñ–¥ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏</h2>
                    <p style="color: #9aa6b6; margin-top: 0.5rem;">–í—ñ–¥–∫—Ä–∏–≤–∞–π—Ç–µ –Ω–æ–≤—ñ —Å–º–∞—á–Ω—ñ —Ä–µ—Ü–µ–ø—Ç–∏, —Å—Ç–≤–æ—Ä–µ–Ω—ñ —ñ–Ω—à–∏–º–∏ –∫—É–ª—ñ–Ω–∞—Ä–∞–º–∏</p>
                </div>
                <div class="header-actions">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <input type="text" id="filterInput" class="page-search" placeholder="–ü–æ—à—É–∫ —Ä–µ—Ü–µ–ø—Ç—ñ–≤...">
                        <button class="catalog-button" id="filterBtn" aria-label="–ü–æ—à—É–∫">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="margin-right:8px; vertical-align:middle;">
                                <circle cx="11" cy="11" r="6"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <span>–ü–æ—à—É–∫</span>
                        </button>
                        <div style="position:relative; margin-left:6px;">
                            <button id="catalogBtnCommunity" class="catalog-button" aria-label="–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó">–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recipes Grid -->
            <section class="recipes-grid" id="recipesGrid" aria-live="polite">
                <!-- recipes will be injected here -->
            </section>

            <!-- Pagination -->
            <div class="pagination" id="pagination" style="max-width:1200px;margin:1.5rem auto;display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;"></div>

            <!-- No Recipes Message -->
            <div id="noRecipesMessage" style="max-width:1200px;margin:2rem auto;display:none;text-align:center;color:#9aa6b6;">
                <p style="font-size:1.2rem;">üòî –†–µ—Ü–µ–ø—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</p>
                <p>–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –∫—Ä–∏—Ç–µ—Ä—ñ—ó –ø–æ—à—É–∫—É –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å —Å–≤—ñ–π —Ä–µ—Ü–µ–ø—Ç!</p>
            </div>

            <!-- Loading indicator -->
            <div id="loadingSpinner" style="max-width:1200px;margin:2rem auto;text-align:center;display:none;">
                <p style="color: #9aa6b6;">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ—Ü–µ–ø—Ç—ñ–≤...</p>
            </div>
        </main>

        <!-- Recipe Modal -->
        <div class="recipe-modal-overlay" id="recipeModal" aria-hidden="true">
            <div class="recipe-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
                <button class="modal-close" id="modalClose" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
                <div class="modal-image-wrap">
                    <img src="images/homepage/salad1.jpg" alt="–§–æ—Ç–æ —Å—Ç—Ä–∞–≤–∏" id="modalImage">
                </div>
                <div class="modal-body">
                    <h3 id="modalTitle">–†–µ—Ü–µ–ø—Ç</h3>
                    <div class="modal-tags">
                        <span class="tag difficulty" id="modalDifficulty">–°–µ—Ä–µ–¥–Ω—è</span>
                        <span class="tag time" id="modalTime">30 —Ö–≤</span>
                    </div>

                    <section class="modal-section ingredients">
                        <h4>–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏:</h4>
                        <ul class="ingredients-list" id="modalIngredients">
                            <!-- ingredients populated by JS -->
                        </ul>
                    </section>

                    <section class="modal-section preparation">
                        <h4>–ü—Ä–∏–≥–æ—Ç—É–≤–∞–Ω–Ω—è:</h4>
                        <ol id="modalPreparation">
                            <!-- steps populated by JS -->
                        </ol>
                    </section>
                        <section class="comments-section" aria-labelledby="commentsTitle">
                            <h4 id="commentsTitle">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</h4>
                            <div class="comments-list" id="modalCommentsList">
                                <!-- comments loaded by JS -->
                            </div>
                            <form id="modalCommentForm" class="comment-form">
                                <textarea name="comment" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä..." required></textarea>
                                <button type="submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
                            </form>
                        </section>
                </div>
            </div>
        </div>

        <!-- Catalog Modal (community page) -->
        <div id="catalogModalCommunity" class="modal" aria-hidden="true">
            <div class="modal-content">
                <button id="closeCatalogCommunity" class="modal-close" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
                <h3>–í–∏–±—Ä–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</h3>
                <div class="categories-modal-grid">
                    <button class="cat-btn" data-category="all">–£—Å—ñ</button>
                    <button class="cat-btn" data-category="breakfast">–°–Ω—ñ–¥–∞–Ω–∫–∏</button>
                    <button class="cat-btn" data-category="lunch">–û–±—ñ–¥</button>
                    <button class="cat-btn" data-category="dinner">–í–µ—á–µ—Ä—è</button>
                    <button class="cat-btn" data-category="soups">–°—É–ø–∏</button>
                    <button class="cat-btn" data-category="salads">–°–∞–ª–∞—Ç–∏</button>
                    <button class="cat-btn" data-category="desserts">–î–µ—Å–µ—Ä—Ç–∏</button>
                    <button class="cat-btn" data-category="snacks">–ó–∞–∫—É—Å–∫–∏</button>
                    <button class="cat-btn" data-category="drinks">–ù–∞–ø–æ—ó</button>
                    <button class="cat-btn" data-category="vegan">–í–µ–≥–∞–Ω—Å—å–∫—ñ</button>
                    <button class="cat-btn" data-category="pastries">–¢—ñ—Å—Ç–µ—á–∫–∞</button>
                </div>
            </div>
        </div>

        <!-- Auth Modal -->
        <div class="auth-modal-overlay" id="authModal" aria-hidden="true">
            <div class="auth-modal" role="dialog" aria-modal="true">
                <button class="modal-close" id="authModalClose" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
                
                <!-- Logo -->
                <div class="auth-logo">
                    <span class="auth-logo-text">–°–º–∞—á–Ω–æ :)</span>
                </div>

                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">–í–•–Ü–î</button>
                    <button class="auth-tab" data-tab="register">–†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø</button>
                </div>
                
                <div class="auth-content">
                    <!-- Login Form -->
                    <form id="loginForm" class="auth-form active">
                        <div class="form-group">
                            <label for="loginName">–Ü–º'—è</label>
                            <input type="text" id="loginName" name="loginName" placeholder="–í–∞—à–µ —ñ–º'—è" required>
                        </div>
                        <div class="form-group">
                            <label for="loginEmail">E-mail</label>
                            <input type="email" id="loginEmail" name="loginEmail" placeholder="your@email.com" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" id="loginPassword" name="loginPassword" placeholder="********" required>
                        </div>
                        <div class="form-checkbox">
                            <input type="checkbox" id="loginRemember" name="loginRemember">
                            <label for="loginRemember">–ó–∞–ø–∞–º'—è—Ç–∞—Ç–∏ –º–µ–Ω–µ</label>
                        </div>
                        <button type="submit" class="auth-submit">–£–í–Ü–ô–¢–ò</button>
                        <div style="margin-top:8px;text-align:right;">
                            <a href="#" id="forgotPasswordLink" class="forgot-link">–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
                        </div>
                    </form>

                    <form id="forgotForm" class="auth-form" style="display:none;">
                        <div class="form-group">
                            <label for="forgotEmail">–í–≤–µ–¥—ñ—Ç—å –≤–∞—à E-mail</label>
                            <input type="email" id="forgotEmail" placeholder="your@email.com" required>
                        </div>
                        <button type="submit" class="auth-submit">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥</button>
                        <div class="back-row">
                            <a href="#" id="backToLoginFromForgot" class="back-link">–ù–∞–∑–∞–¥ –¥–æ –≤—Ö–æ–¥—É</a>
                        </div>
                    </form>

                    <form id="resetForm" class="auth-form" style="display:none;">
                        <div class="form-group">
                            <label for="resetEmail">E-mail</label>
                            <input type="email" id="resetEmail" placeholder="your@email.com" required>
                        </div>
                        <div class="form-group">
                            <label for="resetCode">–ö–æ–¥ –∑ –ø–æ—à—Ç–∏</label>
                            <input type="text" id="resetCode" placeholder="123456" required>
                        </div>
                        <div class="form-group">
                            <label for="resetNewPassword">–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</label>
                            <input type="password" id="resetNewPassword" placeholder="********" required>
                        </div>
                        <button type="submit" class="auth-submit">–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</button>
                        <div class="back-row">
                            <a href="#" id="backToLoginFromReset" class="back-link">–ù–∞–∑–∞–¥ –¥–æ –≤—Ö–æ–¥—É</a>
                        </div>
                    </form>
                    
                    <!-- Register Form -->
                    <form id="registerForm" class="auth-form">
                        <div class="form-group">
                            <label for="registerName">–Ü–º'—è</label>
                            <input type="text" id="registerName" name="registerName" placeholder="–í–∞—à–µ —ñ–º'—è" required>
                        </div>
                        <div class="form-group">
                            <label for="registerEmail">E-mail</label>
                            <input type="email" id="registerEmail" name="registerEmail" placeholder="your@email.com" required>
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">–ü–∞—Ä–æ–ª—å</label>
                            <input type="password" id="registerPassword" name="registerPassword" placeholder="********" required>
                        </div>
                        <div class="form-group">
                            <label for="registerConfirmPassword">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—é</label>
                            <input type="password" id="registerConfirmPassword" name="registerConfirmPassword" placeholder="********" required>
                        </div>
                        <button type="submit" class="auth-submit">–ó–ê–†–ï–Ñ–°–¢–†–£–í–ê–¢–ò–°–Ø</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/transition.js"></script>
    <script src="js/auth-modal.js"></script>
    <script src="js/comments.js"></script>
    <script>
    // Community Recipes Page
    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.getElementById('recipesGrid');
        const noRecipesMsg = document.getElementById('noRecipesMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const filterInput = document.getElementById('filterInput');
        const filterBtn = document.getElementById('filterBtn');
        const modal = document.getElementById('recipeModal');
        const modalClose = document.getElementById('modalClose');

        // Escape HTML
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // map stored category keys to human-friendly Ukrainian labels
        function mapCategory(key) {
            if (!key) return '';
            const map = {
                breakfast: '–°–Ω—ñ–¥–∞–Ω–∫–∏',
                lunch: '–û–±—ñ–¥',
                dinner: '–í–µ—á–µ—Ä—è',
                desserts: '–î–µ—Å–µ—Ä—Ç–∏',
                salads: '–°–∞–ª–∞—Ç–∏',
                soups: '–°—É–ø–∏',
                snacks: '–ó–∞–∫—É—Å–∫–∏',
                drinks: '–ù–∞–ø–æ—ó',
                vegan: '–í–µ–≥–∞–Ω—Å—å–∫—ñ',
                pastries: '–¢—ñ—Å—Ç–µ—á–∫–∞',
                all: '–£—Å—ñ'
            };
            return map[String(key).toLowerCase()] || String(key);
        }

        // convert Ukrainian label (or English key) back to category key used by backend
        function labelToKey(label) {
            if (!label) return '';
            const lookup = {
                '—Å–Ω—ñ–¥–∞–Ω–∫–∏': 'breakfast',
                '—Å–Ω—ñ–¥–∞–Ω–æ–∫': 'breakfast',
                '–æ–±—ñ–¥': 'lunch',
                '–≤–µ—á–µ—Ä—è': 'dinner',
                '–≤–µ—á–µ—Ä—è': 'dinner',
                '–¥–µ—Å–µ—Ä—Ç–∏': 'desserts',
                '—Å–∞–ª–∞—Ç–∏': 'salads',
                '—Å—É–ø–∏': 'soups',
                '–∑–∞–∫—É—Å–∫–∏': 'snacks',
                '–Ω–∞–ø–æ—ó': 'drinks',
                '–≤–µ–≥–∞–Ω—Å—å–∫—ñ': 'vegan',
                '–≤–µ–≥–µ—Ç–∞—Ä—ñ–∞–Ω—Å—å–∫—ñ': 'vegan',
                '—Ç—ñ—Å—Ç–µ—á–∫–∞': 'pastries',
                '—É—Å—ñ': 'all',
            };
            const key = String(label).trim().toLowerCase();
            if (lookup[key]) return lookup[key];
            // if user already typed an english key, allow it
            const englishKeys = Object.keys(lookup).map(k => lookup[k]);
            if (englishKeys.includes(key)) return key;
            return '';
        }

        // Render a single recipe card
        function renderRecipe(recipe) {
            const article = document.createElement('article');
            article.className = 'recipe-card';
            // set recipe id on article for easier access
            if (recipe.id) article.dataset.recipeId = recipe.id;
            // mark source as user for community recipes
            article.dataset.source = 'user';
            // store ingredients and instructions for modal
            article.dataset.ingredients = recipe.ingredients || '';
            article.dataset.instructions = recipe.instructions || '';

            const image = (recipe.image_path && recipe.image_path.trim()) ? recipe.image_path : 'images/homepage/salad1.jpg';
            // Debug: log image path for troubleshooting
            try { console.log('RenderRecipe image:', { id: recipe.id, image }); } catch (e) {}
            const ingredients = recipe.ingredients || '';
            const instructions = recipe.instructions || '';
            const firstIngredient = ingredients.split('|')[0] || '–†–µ—Ü–µ–ø—Ç';
            const timeVal = recipe.cooking_time || recipe.time || '30';
            const time = isNaN(timeVal) ? timeVal : `${timeVal} —Ö–≤`;

            article.innerHTML = `
                <div class="recipe-image" style="background-image: url('${escapeHtml(image)}')"></div>
                <div class="recipe-info">
                    <h4>${escapeHtml(recipe.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏')}</h4>
                    <p class="recipe-description">üë®‚Äçüç≥ ${escapeHtml(recipe.username || '–ê–≤—Ç–æ—Ä')}</p>
                    <p class="recipe-description">${escapeHtml(firstIngredient)}</p>
                    <div class="recipe-meta">
                        <div class="meta-left">
                            <span class="cook-time">${escapeHtml(time)}</span>
                            <span class="recipe-category">${escapeHtml(mapCategory(recipe.category || '–ó–∞–≥–∞–ª—å–Ω–µ'))}</span>
                        </div>
                        <div class="meta-right">
                            <button class="recipe-button">–†–µ—Ü–µ–ø—Ç</button>
                            <button class="details-btn recipe-view-btn" data-recipe='${JSON.stringify(recipe).replace(/'/g, "&apos;")}' style="display:none">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
                            <button class="recipe-like" aria-label="–î–æ–¥–∞—Ç–∏ –≤ —É–ª—é–±–ª–µ–Ω—ñ" data-recipe-id="${recipe.id || ''}">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // ensure like button has source attribute and add direct click handler (fallback)
            const likeBtn = article.querySelector('.recipe-like');
            if (likeBtn) {
                likeBtn.dataset.source = article.dataset.source || 'user';
                // direct click handler in case event delegation misses the click
                likeBtn.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    ev.stopPropagation();
                    console.log('community: like clicked', {recipeId: likeBtn.dataset.recipeId, source: likeBtn.dataset.source});
                    const btn = ev.currentTarget;
                    const articleEl = btn.closest('.recipe-card');
                    const recipeId = btn.dataset.recipeId || articleEl?.dataset.recipeId;
                    const source = btn.dataset.source || articleEl?.dataset.source || 'user';
                    if (!recipeId) return;

                    // Optimistic UI: toggle immediately for feedback
                    const wasLiked = btn.classList.contains('liked');
                    btn.classList.toggle('liked');
                    if (!wasLiked) {
                        btn.style.color = '#ff6b6b';
                        btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>';
                    } else {
                        btn.style.color = '';
                        btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" stroke="currentColor" stroke-width="2"/></svg>';
                    }

                    // Then call backend; if it fails, revert UI
                    fetch('backend/session.php')
                        .then(r => r.json())
                        .then(data => {
                            console.log('community: session response', data);
                            if (data.status !== 'logged') {
                                // revert and open auth
                                btn.classList.toggle('liked');
                                if (wasLiked) { btn.style.color = '#ff6b6b'; btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>'; }
                                else { btn.style.color = ''; btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" stroke="currentColor" stroke-width="2"/></svg>'; }
                                if (typeof openAuthModal === 'function') openAuthModal();
                                else alert('–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞–≤–∞—Ç–∏ —É–ª—é–±–ª–µ–Ω—ñ.');
                                return;
                            }

                            const endpoint = wasLiked ? 'remove-favorite.php' : 'add-favorite.php';
                            const formData = new FormData();
                            formData.append('recipe_id', recipeId);
                            formData.append('source', source);

                            console.log('community: calling favorite endpoint', { endpoint, recipeId, source });

                            fetch('backend/' + endpoint, { method: 'POST', body: formData })
                                .then(r => r.text().then(text => {
                                    // try parse json, if fails log raw text
                                    try {
                                        const json = JSON.parse(text);
                                        console.log('community: favorite endpoint json', json);
                                        return json;
                                    } catch (e) {
                                        console.log('community: favorite endpoint raw response', text);
                                        return { success: false, raw: text };
                                    }
                                }))
                                .then(resp => {
                                    console.log('community: favorite final response', resp);
                                    if (!(resp && (resp.success || resp.status === 'success'))) {
                                        // revert UI
                                        btn.classList.toggle('liked');
                                        if (wasLiked) { btn.style.color = '#ff6b6b'; btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>'; }
                                        else { btn.style.color = ''; btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" stroke="currentColor" stroke-width="2"/></svg>'; }
                                        console.error('Favorite response (direct):', resp);
                                    }
                                })
                                .catch(err => {
                                    // revert on error
                                    btn.classList.toggle('liked');
                                    if (wasLiked) { btn.style.color = '#ff6b6b'; btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>'; }
                                    else { btn.style.color = ''; btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" stroke="currentColor" stroke-width="2"/></svg>'; }
                                    console.error('Favorite error (direct):', err);
                                });
                        })
                        .catch(err => {
                            // revert and show auth modal
                            btn.classList.toggle('liked');
                            if (wasLiked) { btn.style.color = '#ff6b6b'; btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>'; }
                            else { btn.style.color = ''; btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" stroke="currentColor" stroke-width="2"/></svg>'; }
                            console.error('Session check error (direct):', err);
                            if (typeof openAuthModal === 'function') openAuthModal();
                            else alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó.');
                        });
                });
            }
            grid.appendChild(article);
        }

        // Paginated load for community recipes (user-added only)
        const paginationContainer = document.getElementById('pagination');
        let currentPage = 1;
        const perPage = 12;
        // keep track of currently selected category so paging preserves the filter
        let activeCategory = 'all';

        function buildPagination(pagination) {
            if (!paginationContainer) return;
            paginationContainer.innerHTML = '';
            const total = pagination.total_pages || 1;
            for (let i = 1; i <= total; i++) {
                const btn = document.createElement('button');
                btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                btn.textContent = i;
                btn.dataset.page = i;
                btn.addEventListener('click', () => loadRecipes('', activeCategory, Number(btn.dataset.page)));
                paginationContainer.appendChild(btn);
            }
            if (currentPage < total) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'page-next';
                nextBtn.textContent = '‚Üí';
                nextBtn.addEventListener('click', () => loadRecipes('', activeCategory, currentPage + 1));
                paginationContainer.appendChild(nextBtn);
            }
        }

        function loadRecipes(searchTerm = '', category = '', page = 1) {
            console.log('üì• –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ä–µ—Ü–µ–ø—Ç–∏ –≤—ñ–¥ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏... page=', page);
            currentPage = page;
            // persist active category so pagination and other controls keep the filter
            activeCategory = category || activeCategory || 'all';
            loadingSpinner.style.display = 'block';
            grid.innerHTML = '';
            noRecipesMsg.style.display = 'none';

            const params = new URLSearchParams();
            params.append('page', page);
            params.append('per_page', perPage);
            if (searchTerm) params.append('search', searchTerm);
            if (category && category !== 'all') params.append('category', category);

            fetch('backend/get-all-recipes.php?' + params.toString())
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    loadingSpinner.style.display = 'none';
                    if (data.status === 'success' && Array.isArray(data.recipes) && data.recipes.length > 0) {
                        data.recipes.forEach(recipe => renderRecipe(recipe));
                        buildPagination(data.pagination || { total_pages: 1 });
                        noRecipesMsg.style.display = 'none';
                        // Mark favorites robustly: support keys like "user:ID", "admin:ID" or plain "ID"
                        fetch('backend/get-favorites.php')
                            .then(r => r.json())
                            .then(favData => {
                                if (favData && Array.isArray(favData.favorites)) {
                                    const favSet = new Set(favData.favorites.map(String));
                                    document.querySelectorAll('.recipe-like').forEach(btn => {
                                        const article = btn.closest('.recipe-card');
                                        const id = (btn.dataset.recipeId || article?.dataset.recipeId || '').toString();
                                        const source = (btn.dataset.source || article?.dataset.source || 'user').toString();
                                        if (!id) return;
                                        const possibleKeys = [
                                            `${source}:${id}`,
                                            `user:${id}`,
                                            `admin:${id}`,
                                            `${id}`
                                        ];
                                        for (const key of possibleKeys) {
                                            if (favSet.has(key)) {
                                                btn.classList.add('liked');
                                                btn.style.color = '#ff6b6b';
                                                btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>';
                                                break;
                                            }
                                        }
                                    });
                                }
                            })
                            .catch(err => { console.log('Could not load favorites for community page:', err); });
                    } else {
                        grid.innerHTML = '';
                        noRecipesMsg.style.display = 'block';
                        if (paginationContainer) paginationContainer.innerHTML = '';
                    }
                })
                .catch(error => {
                    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', error);
                    loadingSpinner.style.display = 'none';
                    grid.innerHTML = `<p style="color:#ff6b6b; grid-column: 1/-1; text-align: center;">‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ—Ü–µ–ø—Ç—ñ–≤</p>`;
                });
        }

        // Open recipe modal
        function openRecipeModal(recipe) {
            document.getElementById('modalImage').src = (recipe.image_path && recipe.image_path.trim()) ? recipe.image_path : 'images/homepage/salad1.jpg';
            document.getElementById('modalTitle').textContent = recipe.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏';
            
            // Set difficulty and time (extracted from ingredients first line or default)
            const difficulty = recipe.difficulty || '–°–µ—Ä–µ–¥–Ω—è';
            const time = recipe.cooking_time ? `${recipe.cooking_time} —Ö–≤` : '30 —Ö–≤';
            
            const difficultyTag = document.getElementById('modalDifficulty');
            const timeTag = document.getElementById('modalTime');
            if (difficultyTag) difficultyTag.textContent = difficulty;
            if (timeTag) timeTag.textContent = time;
            
            const ingredientsList = document.getElementById('modalIngredients');
            ingredientsList.innerHTML = '';
            (recipe.ingredients || '').split('|').forEach(ing => {
                if (ing.trim()) {
                    const li = document.createElement('li');
                    li.textContent = ing.trim();
                    ingredientsList.appendChild(li);
                }
            });
            
            const preparationList = document.getElementById('modalPreparation');
            preparationList.innerHTML = '';
            (recipe.instructions || '').split('|').forEach(step => {
                if (step.trim()) {
                    const li = document.createElement('li');
                    li.textContent = step.trim();
                    preparationList.appendChild(li);
                }
            });
            
            // mark current recipe id on modal and notify listeners
            try { modal.setAttribute('data-recipe-id', recipe.id || recipe.recipe_id || ''); } catch (e) {}
            document.dispatchEvent(new CustomEvent('recipeModalOpen', { detail: { recipeId: recipe.id || recipe.recipe_id || '' } }));
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
        }

        // Close modal
        function closeModal() {
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
        }

        // Event listeners
        filterBtn.addEventListener('click', () => {
            const inputVal = (filterInput.value || '').trim();
            const key = labelToKey(inputVal);
            if (key) {
                // if matches a known category label -> filter by category key
                activeCategory = key;
                if (key === 'all') loadRecipes('', 'all');
                else loadRecipes('', key);
            } else {
                // search term (clear category)
                activeCategory = 'all';
                loadRecipes(inputVal, 'all');
            }
        });

        filterInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const inputVal = (filterInput.value || '').trim();
                const key = labelToKey(inputVal);
                if (key) {
                    activeCategory = key;
                    if (key === 'all') loadRecipes('', 'all');
                    else loadRecipes('', key);
                } else {
                    activeCategory = 'all';
                    loadRecipes(inputVal, 'all');
                }
            }
        });

        modalClose.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // Handle recipe button clicks (shows modal with recipe details)
        grid.addEventListener('click', (e) => {
            if (e.target.classList.contains('recipe-button')) {
                const card = e.target.closest('.recipe-card');
                if (card && card.dataset.recipeId) {
                    // Get recipe data from card's data-* attributes
                    const recipe = {
                        id: card.dataset.recipeId,
                        title: card.querySelector('h4')?.textContent || '–ë–µ–∑ –Ω–∞–∑–≤–∏',
                        image_path: card.querySelector('.recipe-image')?.style.backgroundImage?.replace(/url\(["']?/, '').replace(/["']?\)/, '') || 'images/homepage/salad1.jpg',
                        username: card.querySelector('.recipe-description')?.textContent.replace('üë®‚Äçüç≥ ', '') || '–ê–≤—Ç–æ—Ä',
                        created_at: card.querySelector('.cook-time')?.textContent || '–ù–µ–¥–∞–≤–Ω–æ',
                        category: card.querySelector('.recipe-category')?.textContent || '–ó–∞–≥–∞–ª—å–Ω–µ',
                        ingredients: card.dataset.ingredients || '',
                        instructions: card.dataset.instructions || ''
                    };
                    openRecipeModal(recipe);
                }
            }
            if (e.target.classList.contains('recipe-view-btn')) {
                try {
                    const recipeData = JSON.parse(e.target.dataset.recipe);
                    openRecipeModal(recipeData);
                } catch (err) {
                    console.error('Error parsing recipe:', err);
                }
            }
            // Note: like/unlike is handled by a direct per-button listener to avoid double-handling
        });

        // Initial load
        loadRecipes();

        // Catalog modal for community page ‚Äî open modal and delegate category clicks
        const catalogBtnCommunity = document.getElementById('catalogBtnCommunity');
        const catalogModalCommunity = document.getElementById('catalogModalCommunity');
        const closeCatalogCommunity = document.getElementById('closeCatalogCommunity');
        if (catalogBtnCommunity && catalogModalCommunity) {
            catalogBtnCommunity.setAttribute('aria-haspopup', 'dialog');
            catalogBtnCommunity.setAttribute('aria-expanded', 'false');
            catalogBtnCommunity.addEventListener('click', (e) => {
                e.stopPropagation();
                catalogModalCommunity.setAttribute('aria-hidden', 'false');
                catalogModalCommunity.classList.add('show');
                catalogBtnCommunity.setAttribute('aria-expanded', 'true');
                const first = catalogModalCommunity.querySelector('.cat-btn');
                if (first && typeof first.focus === 'function') first.focus();
            });

            if (closeCatalogCommunity) {
                closeCatalogCommunity.addEventListener('click', () => {
                    catalogModalCommunity.setAttribute('aria-hidden', 'true');
                    catalogModalCommunity.classList.remove('show');
                    if (catalogBtnCommunity) catalogBtnCommunity.setAttribute('aria-expanded', 'false');
                    if (catalogBtnCommunity && typeof catalogBtnCommunity.focus === 'function') catalogBtnCommunity.focus();
                });
            }

            // click outside modal closes it
            catalogModalCommunity.addEventListener('click', (ev) => {
                if (ev.target === catalogModalCommunity) {
                    catalogModalCommunity.setAttribute('aria-hidden', 'true');
                    catalogModalCommunity.classList.remove('show');
                    if (catalogBtnCommunity && typeof catalogBtnCommunity.focus === 'function') catalogBtnCommunity.focus();
                }
            });

            // esc closes
            document.addEventListener('keydown', (ev) => {
                if (ev.key === 'Escape') {
                    catalogModalCommunity.setAttribute('aria-hidden', 'true');
                    catalogModalCommunity.classList.remove('show');
                    if (catalogBtnCommunity && typeof catalogBtnCommunity.focus === 'function') catalogBtnCommunity.focus();
                }
            });

            // delegate category clicks inside modal
            catalogModalCommunity.addEventListener('click', (e) => {
                const b = e.target.closest('.cat-btn');
                if (!b) return;
                const cat = (b.dataset.category || '').toString().toLowerCase();
                const label = b.textContent || cat;
                const fi = document.getElementById('filterInput');
                if (fi) fi.value = label;
                catalogModalCommunity.setAttribute('aria-hidden', 'true');
                catalogModalCommunity.classList.remove('show');
                if (catalogBtnCommunity) catalogBtnCommunity.setAttribute('aria-expanded', 'false');
                if (catalogBtnCommunity && typeof catalogBtnCommunity.focus === 'function') catalogBtnCommunity.focus();
                activeCategory = cat || 'all';
                loadRecipes('', activeCategory);
            });
        }
    });
    </script>
</body>
</html>
